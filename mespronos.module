<?php

/**
 * @file
 * Contains mespronos.module.
 */

use Symfony\Component\HttpFoundation\RedirectResponse;

function mespronos_preprocess_page(&$variables) {
  if($variables['is_admin']) {
    $variables['#attached']['library'][] = 'mespronos/administration-style';
  }
  $variables['#attached']['library'][] = 'mespronos/front-style';
}

function mespronos_theme() {
  $theme = [];
  $theme['user-block'] = array(
    'template' => 'user-block',
    'variables' => array(
      'user' => NULL,
      'user_picture' => NULL,
      'links' => NULL,
    ),
  );
  $theme['user-profile-block'] = array(
    'template' => 'user-profile-block',
    'variables' => array(
      'user' => NULL,
      'statistics' => NULL,
      'last_bets' => NULL,
      'user_picture' => NULL,
      'links' => NULL,
    ),
  );
  $theme['block-bet-informations'] = array(
    'template' => 'block_bet_informations',
    'variables' => array(
      'day' => NULL,
      'league' => NULL,
    ),
  );
  $theme['leagues-list'] = array(
    'template' => 'leagues-list',
    'variables' => array(
      'leagues' => [],
    ),
  );
  $theme['league-details'] = array(
    'template' => 'league_details',
    'variables' => array(
      'last_bets' => NULL,
      'next_bets' => NULL,
      'ranking' => NULL,
    ),
  );
  $theme['day-details'] = array(
    'template' => 'day_details',
    'variables' => array(
      'last_bets' => NULL,
      'ranking' => NULL,
    ),
  );
  $theme['dashboard'] = array(
    'template' => 'dashboard',
    'variables' => array(
      'marks_form' => NULL,
      'stats' => NULL,
    ),
  );
  $theme['day'] = array(
    'template' => 'day',
    'variables' => array(
      'league' => NULL,
      'day' => NULL,
    ),
  );
  $theme['user-ranking'] = array(
    'template' => 'user-ranking',
    'variables' => array(
      'user' => NULL,
    ),
  );

  return $theme;
}


/**
 * @todo create a proper page in \Drupal\mespronos\Controller\UserController
 */
function mespronos_form_user_register_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  $form['account']['pass']['#description'] = null;
  $form['account']['mail']['#description'] = null;
  $form['account']['name']['#description'] = null;
  $form['status']['#access'] = false;
  $form['roles']['#access'] = false;
  $form['notify']['#access'] = false;
  $form['user_picture']['widget'][0]['#description'] = null;
  $form['contact']['#access'] = false;
}

function mespronos_form_user_login_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  unset($form['name']['#attributes']['autofocus']);
  $form['#submit'][] = 'mespronos_form_user_login_form_submit';
}

function mespronos_form_user_login_form_submit(&$form, \Drupal\Core\Form\FormStateInterface $form_state) {
  $form_state->setRedirect('<front>');
}

function mespronos_user_login($account) {
  $destination = \Drupal::destination()->getAsArray();
  if(isset($destination['destination'])) {
    return new RedirectResponse($destination['destination']);
  }
}