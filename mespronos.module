<?php

/**
 * @file
 * Contains mespronos.module.
 */

use Symfony\Component\HttpFoundation\RedirectResponse;
use Drupal\Core\Entity\Entity\EntityViewDisplay;
use Drupal\mespronos\Entity\Game;
use Drupal\mespronos\Controller\BetController;

function mespronos_preprocess_page(&$variables) {
  if($variables['is_admin']) {
    $variables['#attached']['library'][] = 'mespronos/administration-style';
  }
  $variables['#attached']['library'][] = 'mespronos/front-style';
}

function mespronos_theme() {
  $theme = [];
  $theme['user-block'] = array(
    'template' => 'user-block',
    'variables' => array(
      'user' => NULL,
      'user_picture' => NULL,
      'links' => NULL,
    ),
  );
  $theme['user-profile-block'] = array(
    'template' => 'user-profile-block',
    'variables' => array(
      'user' => NULL,
      'statistics' => NULL,
      'palmares' => NULL,
      'last_bets' => NULL,
      'user_picture' => NULL,
      'links' => NULL,
    ),
  );
  $theme['block-bet-informations'] = array(
    'template' => 'block_bet_informations',
    'variables' => array(
      'day' => NULL,
      'league' => NULL,
    ),
  );
  $theme['leagues-list'] = array(
    'template' => 'leagues-list',
    'variables' => array(
      'leagues' => [],
    ),
  );
  $theme['league-details'] = array(
    'template' => 'league_details',
    'variables' => array(
      'last_bets' => NULL,
      'next_bets' => NULL,
      'ranking' => NULL,
    ),
  );
  $theme['day-details'] = array(
    'template' => 'day_details',
    'variables' => array(
      'last_bets' => NULL,
      'ranking' => NULL,
      'has_group' => false,
      'group_name' => NULL,
      'ranking_group' => NULL,
    ),
  );
  $theme['dashboard'] = array(
    'template' => 'dashboard',
    'variables' => array(
      'marks_form' => NULL,
      'stats' => NULL,
    ),
  );
  $theme['day'] = array(
    'template' => 'day',
    'variables' => array(
      'league' => NULL,
      'day' => NULL,
    ),
  );
  $theme['league'] = array(
    'template' => 'league',
    'variables' => array(
      'league' => NULL,
    ),
  );
  $theme['user-ranking'] = array(
    'template' => 'user-ranking',
    'variables' => array(
      'user' => NULL,
    ),
  );
  $theme['bet-reminder'] = array(
    'template' => 'bet-reminder',
    'variables' => array(
      'user' => NULL,
      'day' => NULL,
    ),
  );

  return $theme;
}

function mespronos_form_user_login_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  unset($form['name']['#attributes']['autofocus']);
  $form['#submit'][] = 'mespronos_form_user_login_form_submit';
}

function mespronos_form_user_login_form_submit(&$form, \Drupal\Core\Form\FormStateInterface $form_state) {
  $form_state->setRedirect('<front>');
}

function mespronos_user_login($account) {
  $destination = \Drupal::destination()->getAsArray();
  if(isset($destination['destination'])) {
    return new RedirectResponse($destination['destination']);
  }
}

function mespronos_mail($key, &$message, $params) {
  $message['from'] = \Drupal::config('system.site')->get('mail');
  $message['subject'] = $params['subject'];
  $message['body'][] = $params['message'];
  $message['options'] = [];
  if (isset($params['options']) && !empty($params['options'])) {
    foreach ($params['options'] as $key => $value) {
      $message['options'][$key] = $value;
    }
  }
}

function mespronos_cron() {
  \Drupal\mespronos\Controller\ReminderController::init();
}

function mespronos_entity_extra_field_info() {
  $extra['user']['user']['display']['hall_of_flame'] = array(
    'label' => t('Hall of flame'),
    'weight' => 100,
    'visible' => TRUE,
  );
  return $extra;
}

function mespronos_user_view(array &$build, Drupal\user\Entity\User $entity, EntityViewDisplay $display, $view_mode) {
  if($view_mode == 'full') {
    $block_manager = \Drupal::service('plugin.manager.block');
    if ($display->getComponent('hall_of_flame')) {
      $plugin_block = $block_manager->createInstance('user_profil_block', []);
      $render = $plugin_block->build();
      $build['hall_of_flame'] = [];
      $build['hall_of_flame']['content'] = [
        '#type' => 'container',
        "element-content" => $render,
      ];
    }

  }
}
